<!DOCTYPE html>
<html lang="en">

<head>
  <title>GraymanRe</title>
  <meta name='description' content='Personal Portfolio & Project Website'>
  <link rel="canonical" href="/">
  <link rel="alternate" type="application/rss+xml" title="GraymanRe" href="/feed.xml">
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Ionicons -->
  <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/main.css">
</head>

<body class="is-in">
  <!-- begin header -->
  <header class="header">
    <div class="container">
      <div class="row">
        <div class="header__inner col col-12">
          <div class="logo">
            <a class="logo__link" href="/">GraymanRe</a>
          </div>
          <div class="menu-overlay">
            <nav class="main-nav">
              <div class="main-nav__box">
                <div class="nav__icon-close">
                  <i class="ion ion-md-close"></i>
                </div>
                <div class="nav-grid">
                  <div class="nav-grid__item">
                    <h2 class="nav-grid__title">Menu</h2>
                    <div class="mobile-nav">
                      <ul class="nav__list list-reset">
                        <li class="nav__item"><a href="/" class="nav__link">Home</a></li>
                        <li class="nav__item"><a href="/rev/" class="nav__link">Reverse Engineering Projects</a></li>
                        <li class="nav__item"><a href="/blue" class="nav__link">Blue Team Projects</a></li>
                        <li class="nav__item"><a href="/ctf/" class="nav__link">CTF Writeups</a></li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </nav>
          </div>
          <div class="navigation">
            <div class="top-nav">
              <ul class="nav__list list-reset">
                <li class="nav__item"><a href="/" class="nav__link">Home</a></li>
                <li class="nav__item"><a href="/rev/" class="nav__link">Reverse Engineering Projects</a></li>
                <li class="nav__item"><a href="/blue" class="nav__link">Blue Team Projects</a></li>
                <li class="nav__item"><a href="/ctf/" class="nav__link">CTF Writeups</a></li>
              </ul>
            </div>
          </div>
          <div class="nav-buttons">
            <i class="nav__icon nav__icon-menu ion ion-md-menu"></i>
            <div class="search-button">
              <i class="nav__icon nav__icon-search ion ion-md-search"></i>
              <span>Search</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  <!-- end header -->

  <!-- begin search -->
  <div class="search">
    <div class="container">
      <div class="row">
        <div class="col col-12">
          <div class="search__box">
            <div class="search__group">
              <div class="search__close">
                <i class="ion ion-md-close"></i>
              </div>
              <label for="js-search-input" class="screen-reader-text">Search for Post</label>
              <input type="text" id="js-search-input" class="search__text" autocomplete="off"
                placeholder="Type to search...">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row search-results-list" id="js-results-container"></div>
    </div>
  </div>
  <!-- end search -->

  <!-- Start of custom content -->
  <main class="content" aria-label="Content">
    <div class="post-head">
      <div class="container">
        <div class="row">
          <div class="col col-2"></div>
          <div class="col col-8 col-t-12">
            <div class="post-head__box">
              <div class="post__meta">
                <span class="post__minutes">8 min read <time class="post__date" datetime="2023-09-25T00:00:00+02:00">Sep
                    25, 2023</time>
                </span>
              </div>
              <h2 class="post__title">M365 Incident Response</h2>
              <div class="post__bottom">
                <div class="post__author">
                  <a href="/contact/" aria-label="GraymanRe"><img class="post__author-image"
                      src="/img/GraymanRe_banner.png" alt="GraymanRe's Picture"></a>
                </div>
                <div class="post__bottom-meta">
                  <a href="/contact/" class="post__author-link">GraymanRe</a>
                  <span>in</span>
                  <span class="post-tags">
                    <a href="/blue" class="post__tag">Blue Team Projects</a>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- begin post -->
    <div class="container">
      <article class="post animate">
        <div class="post__content">
          <h3 id="post__content__title">M365 Incident Response</h3>
          <p>
            I was recently involved in the incident response process at a private organization which fell victim to a
            phishing campaign that led to a fraud case, resulting in the loss of financial assets.             
            <br><br>
            <a href="">In another post</a>, I previously discussed that the vastness of the Entra platform, especially if an organization 
            utilizes a Microsoft E3 or E5 license, ensures that customers can use, enable, and implement a broad range of security settings and features. 
            Although this allows for fine-grained control over the Microsoft tenant, it could also lead to "control exhaustion", leaving administrators
            underinformed regarding the location of specific security options and settings which eventually leads to tenants being vulnerable and exposed. Personally, I like to use 
            <a href="https://m365maps.com">m365maps</a> to refresh my knowledge of the vast landscape of features that come with specific Microsoft 
            licenses, and use it, amongst others, to further develop the automated tenant assessment. The overviews provided demonstrate that with each 
            license, especially enterpise licenses, customers are equiped with a wide control plane. 
            <br><br>
            I often see organizations that are both new to the cloud and have only a small IT team that is additionally responsible for IT security.
            This combination often leads to fatigue and increased responsibilities as well as a need for (de-)prioritization. Thesee organizations,
            and especially the IT teams are prone to suffer control exhaustion and unintentionally and unwittingly leave their tenants exposed. During
            the incident response we noticed that the current configuration of the tenant inadvertently made the life of the attackers easier requiring
            them to use less stealth and gain more access than normally should be the case.
            <br><br>
            The goal of this blog post is to take the reader along on a journey, indicating how the incident response and analysis process was performed,
            based on which logs, how these can and should be enabled and several other useful features that could contribute to securing M365 tenants. 
            <br>
            <h3 id="post__content__title2">How the attackers gained access</h3>
            As I briefly touched upon, the attack started by a phishing email impersonating a specific third-party application that the organization uses
            to sign documents with. The application was, amongst other departments, used by the finance department, and one of the receivers of the
            phishing email was employed in said finance department. A multitude of controls exist that should protect your M365 environment:
            <lu>
              <li>Microsoft Defender Threat Policies</li>
              <li>Session Lifetime</li>
              <li>Conditional Access and Unmanaged Devices</li>
            </lu>
            <br>
            Within the M365 environment, the Microsoft Defender portal is the place to be in terms of mitigating phishing, spam, malware and other types
            of unwanted forms of malicious content (such as attachments and links). The policies to limit the exposure of employees to unwanted malicious
            content require at a bare minimum some scrutiny and preferably custom configuration to protect employees. For administrators that want to
            achieve quick results, Microsoft offers <b>Preset Security Policies</b> which allow to enable a baseline and/or a more aggressive protection 
            profile. By enabling one of these or both profiles, under the hood a <b>Standard or Strict Anti-Spam Policy, Anti-Malware Policy and Anti-Phishing
            Policy</b> will be enabled. For M365 E5 or Defender for Office 365 customers, the <b>Standard or Strict Advanced Phishing Policy, Safe Links 
            Policy and Safe Attachments Policy</b> will be enabled. All the specifics of these policies and the differences between Standard and Strict 
            are covered in detail on the <a href="https://learn.microsoft.com/en-us/microsoft-365/security/office-365-security/recommended-settings-for-eop-and-office365?view=o365-worldwide">Microsoft Website</a>.
            By enabling one of these policies, a strong foundation is laid to protect your users from most generic spam, phishing and other malicious 
            emails that may aim to reach their mailboxes. 
            <br>
            Administrators that reequire more customization and fine-grained control over 

            <br><br>
            <h3 id="post__content__title2">How the attackers achieved persistence</h3>
            Once the employee clicked the link in the phishing email, they were redirected to a phishing page which ended up stealing their active, valid,
            Microsoft Cloud token. By replaying the token, the attackers achieved ongoing, continuous access. A significant point to be made was that
            the organization had not sufficiently configured the lifetime of tokens and requirements for re-authentication or refreshing MFA. This 
            subsequently led to a token lifetime of over 14 days. Allowing the attackers a significant timeframe in which they could freely roam the
            environment and gather intelligence and perform additional activities. As Microsoft clearly and in a detailed manner explains <a href="https://www.microsoft.com/en-us/security/blog/2022/11/16/token-tactics-how-to-prevent-detect-and-respond-to-cloud-token-theft/">
            how cloud token theft takes place</a>, I won't go into to much details here. It basically boils down to attackers obtaining an Attacker-in-
            the-Middle position which allows them to replay a session token with a completed MFA check.

            Organizations that want to immediately respond to such activities, are recommended to closely monitor their Risky Sign-In logs and look for
            the "token "

            Furthermore, it is trivial that organizations limit the lifetime of sessions. This decreases the operation window of attackers that have
            obtained a token by requiring reauthentication after a certain amount of time. Note that organizations need to find a harmony between a low
            lifetime and user convenience. If the lifetime is too low, this could lead to inconvencies as users would be required to reauthenticated 
            themselves. The session lifetime  

            <div>
              <img src="../img/preset_secpolicies.png" alt="Preset Security Policies" onclick="window.open(this.src, '_blank');"
              width="561", height="346" onmouseover="this.style.cursor='zoom-in'" onmouseout="this.style.cursor='default'">
            </div>
            
            <br><br>
            <h3 id="post__content__title3">Adhering to Zero Trust and the principle of least privilege</h3>
            The usage of the Microsoft Graph API allows the creation of an application registration within the Microsoft
            Tenant. By creating an application registration, a single application, in this case Microsoft Graph API can be
            granted a limited subset of permissions to perform its task. The permissions to perform the automated tenant
            assessment only require "read" rights, further limiting the privileges that are obtained by the application
            registration. Furthermore, the organization can then on a as-needed basis add users to the application
            registration. <b>As a result, only a single instance exists where users obtain limited permissions to read
            configurations and when the application registration is removed, no privileges are inherited by users.</b>
            <br><br>
            <h3 id="post__content__title4">A short demonstration</h3>
            The chosen framework to build the automated tenant assessment in is PowerShell. It is natively supported by
            Windows and provides the most versatile solution for the multiple APIs and Graph SDK that are used.<br>
            An example of lowering the manual labor required for obtaining all security-related settings can be
            demonstrated through the Endpoint DLP Settings in the Microsoft Purview Compliance Center. The Endpoint DLP
            Settings contain 14 main configurable settings of which multiple have subsettings that can be configured
            additionally.
            By manually going through every setting, a lot of clicking and opening of subviews etc. is required.
            Additionally, one needs to properly document where these settings are located and doing that for every single
            setting requires a lot of documentation.
            Furthermore, as Microsoft continuously improves and changes the layout of their products, it is likely that
            locations of these settings may change, which requires that the documentation on where each setting is located
            needs to be checked and updated in the documentation.
            <br><br>
            On the other hand, Microsoft provides through the Security & Compliance PowerShell a single cmdlet
            <pre class="highlight-inline"><code>Get-PolicyConfig</code></pre>, to obtain the details on all 14 settings
            and their respective subsettings, which can then be looped over and the results printed or stored as required.
            A simple solution for implementing the cmdlet is demonstrated below:
            <br><br>
            <div class="container">
                <div class="row">
                <div class="col col-4">
                    <img src="/img/entra_tenant_assessment_dplsettings.png" alt="Entra Tenant Assessment Dashboard">
                </div>
                <div class="col col-8">
                    <div class="language-plaintext highlighter-rouge">
                    <div class="highlight">
                        <pre class="highlight"
                        style="padding-left: 10px; padding-right: 10px;"><code>$ClientId = "a0a0a0a0-0000-aaaa-0a0a-a0a0a0a0a0a0"<br>$TenantId = "f9f9f9f9-9999-ffff-9f9f-f9f9f9f9f9f9"<br><br>Connect-MgGraph -ClientId $ClientId -TenantId $TenantId<br><br>$dlpSettingsObject = Get-PolicyConfig<br>$dlpSettings = $dlpSettingsObject.EndpointDlpGlobalSettings<br>if ($dlpSettings) { <br>&emsp;foreach($dlpSetting in $dlpSettings) { <br>&emsp;&emsp;if ($null -ne $dlpSetting.Value and $null -ne $dlpSetting.Setting) { <br>&emsp;&emsp;&emsp;&emsp;Write-Host "$($dlpSetting.Setting): $($dlpSetting.Value)" <br>&emsp;&emsp;} <br>&emsp;} <br>}</code></pre>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            <h3 id="post__content__title3">Findings report</h3>
            To ensure that anyone could have simple access to the findings without the need for understanding how the
            code works, or performing any form of parsing, the automated tenant assessment PowerShell script, reports all its
            findings in an HTML file. The results of the PowerShell queries are added into lists that are combined in an
            HTML template. A significant portion of the template is built on Javascript, which performs parsing of the
            results and building of HTML elements to provide a sleek and low-latency locally-hosted dashboard. The HTML
            template is a single file which allows for easy portability and sharing. The screenshot below shows a small
            preview of what the dashboard looks like.
          </p>
        </div>
      </article>
    </div>
    <!-- end post -->
  </main>
  <!-- End of custom content -->

  <div class="top" title="Top"><i class="ion ion-ios-arrow-up"></i></div>
  <!-- begin footer-widgets -->
  <section class="footer-widgets">
    <div class="container">
      <div class="row">
        <div class="col col-4 col-d-6 col-t-12">
          <div class="widget widget-tag-cloud">
            <div class="widget__head">
              <h3 class="widget__title">Explore Tags</h3>
            </div>
            <div class="tag__cloud">
              <a href="/rev/" class="set-1">Reverse Engineering</a>
              <a href="/blue/" class="set-1">Blue Team</a>
              <a href="/ctf/" class="set-5">CTF</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- end footer-widgets -->

  <!-- begin footer -->
  <footer class="footer">
    <div class="container">
      <div class="row">
        <div class="col col-12">
          <div class="footer__inner">
            <div class="copyright">2023 &copy; <a href="/">GraymanRe</a>.</div>
            <div class="social">
              <ul class="social__list list-reset">
                <li class="social__item">
                  <a class="social__link" href="https://twitter.com/grayman_re" aria-label="social icon"><i
                      class="ion ion-logo-twitter"></i></a>
                </li>
                <li class="social__item">
                  <a class="social__link" href="https://github.com/GraymanRe" aria-label="social icon"><i
                      class="ion ion-logo-github"></i></a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <!-- end footer -->
  <script src="/js/vendors/jquery-3.5.1.min.js"></script>
  <script src="/js/vendors/simple-jekyll-search.min.js"></script>
  <script src="/js/vendors/jquery.fitvids.js"></script>
  <script src="/js/vendors/lazyload.min.js"></script>
  <script src="/js/vendors/transition.js"></script>
  <script src="/js/vendors/zoom.min.js"></script>
  <script src="/js/common.js"></script>
  <script>
    var base_url = "",
      pagination_next_url = base_url + '/page2',
      pagination_next_page_number = '',
      pagination_available_pages_number = '1';
  </script>
</body>

</html>