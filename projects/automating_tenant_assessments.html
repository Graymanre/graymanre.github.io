<!DOCTYPE html>
<html lang="en">

<head>
    <meta property="og:title" content="GraymanRe - Automating M365 Assessments" />
    <meta property="og:description" content="Automating M365 Assessments" />
    <meta property="og:image" content="https://graymanre.github.io/img/entra_tenant_assessment.webp" />
    <meta property="og:url" content="https://graymanre.github.io/" />
    <meta name="description" content="Deep dive into automating Microsoft 365 product security maturity assessment"/>
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:image" content="https://graymanre.github.io/img/entra_tenant_assessment.webp" />
    <meta name="twitter:creator" content="@grayman_re" />

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>GraymanRe - Automating M365 Assessments</title>

    <link rel="canonical" href="https://graymanre.github.io/">
    <link rel="alternate" type="application/rss+xml" title="GraymanRe" href="/feed.xml">
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Ionicons -->
    <link href="https://unpkg.com/ionicons@4.2.2/dist/css/ionicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/prism.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#header-content').load('https://graymanre.github.io/header.html', function () {
                $.getScript('/js/common.js');
            });
            $("#footer-content").load("https://graymanre.github.io/footer.html");
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4VZEKGVZPK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-4VZEKGVZPK');
    </script>
</head>

<body class="is-in">
    <!-- begin header -->
    <header class="header">
        <div id="header-content"></div>
    </header>
    <!-- end header -->
    <!-- begin search -->
    <div class="search">
        <div class="container">
            <div class="row">
                <div class="col col-12">
                    <div class="search__box">
                        <div class="search__group">
                            <div class="search__close">
                                <i class="ion ion-md-close"></i>
                            </div>
                            <label for="js-search-input" class="screen-reader-text">Search for Post</label>
                            <input type="text" id="js-search-input" class="search__text" autocomplete="off" placeholder="Type to search...">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row search-results-list" id="js-results-container"></div>
        </div>
    </div>
    <!-- end search -->
    <!-- Start of custom content -->
    <main class="content" aria-label="Content">
        <div class="post-head">
            <div class="container">
                <div class="row">
                    <div class="col col-2"></div>
                    <div class="col col-8 col-t-12">
                        <div class="post-head__box">
                            <div class="post__meta">
                                <span id="time"></span> min read <time class="post__date" datetime="2023-09-25T00:00:00+02:00">25 September 2023</time>
                            </div>
                            <h2 class="post__title">Automating M365 Tenant Security Maturity Assessments</h2>
                            <div class="post__bottom">
                                <div class="post__author">
                                    <a href="/contact/" aria-label="GraymanRe">
                                        <img class="post__author-image"
                                             src="/img/banner.webp" alt="GraymanRe's Picture">
                                    </a>
                                </div>
                                <div class="post__bottom-meta">
                                    <a href="/contact/" class="post__author-link">GraymanRe</a>
                                    <span>in</span>
                                    <span class="post-tags">
                                        <a href="/projects" class="post__tag">Projects</a>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- begin post -->
        <div class="container">
            <article id="article" class="post animate">
                <div class="post__content">
                    <h3 id="post__content__title">Introduction - Microsoft Entra ID and Microsoft 365 Suite</h3>
                    <p>
                        As the influence of the cloud has increased over the past 10 years, Microsoft have rolled out their cloud-based identity and access
                        management solution called Entra ID. With this, organization could transform their on-premises Active Directory into a hybrid or even
                        full-cloud based environment. As Entra ID and subsequently Microsoft 365 (including OneDrive, SharePoint, Microsoft Defender, Exchange, 
                        etc.) have matured, the platform has increased its vast array of security configurations and policies that aim to safeguard these 
                        hybrid- or full-cloud-based tenants from threat actors. 
                        <br><br>
                        The vastness of the Entra/M365 suite ensures that customers can use, enable, and implement a broad range of security settings and
                        features. This allows for fine-grained control over the Microsoft Tenant whilst simultaneously resulting in the need for experienced
                        administrators that are intricately familiar with the platform.
                        <br><br>
                        Exactly this challenge is what we aim to address in this blog post.
                        <br>
                        <h3 id="post__content__title2">About Microsoft Graph PowerShell</h3>
                        Both new and experienced organisations can have a hard time keeping up with the ever changing landscape of M365 products.
                        For organisations that are new to the M365 suite, a new world arises with seeminly endless possibilities and at least as
                        many portals, admin centers and configuration screens. If we look at the array of products included in a M365 Enterprise
                        subscription, which is comprehensivly shown thanks to <a href="https://m365maps.com">M365Maps.com</a>, it is no wonder
                        that even experienced organisations may overlook a setting or two to increase either security, resilience or comfort.
                        <img class="rounded" src="/img/M365E.png" alt="Entra Tenant Assessment App Registrations" onclick="window.open(this.src, '_blank');"
                             width="561" , height="346" onmouseover="this.style.cursor='zoom-in'" onmouseout="this.style.cursor='default'"><br><br>
                        By providing M365 Tenant Security Maturity and Modern Workplace Assessments, the goal is to provide a comprehensive overview
                        of completeness, by checking all known locations for settings that improve security, resilience, logging, monitoring, etc.
                        As an example, on average each assessment would include Microsoft Entra, Microsoft SharePoint, Microsoft OneDrive, Microsoft Defender
                        for Endpoint, Microsoft Defender for Cloud Apps, Microsoft Exchange Online, Microsoft Intune and Microsoft Defender for Office.
                        In the early days, this assessment was done by hand, having to go through each admin portal and configuration webpage and
                        single-handedly checking each setting one by one. With proper documentation lacking, anyone doing the assessment would additionally
                        have to spent some extra time to research where specific settings could be found - for over 100 settings a devilish task.
                        <br><br>
                        In an attempt to maximize my output, I researched other avenues to perform the security assessment that would drastically lower
                        the amount of manual labor required. I had previously heard of the <b><a href="https://learn.microsoft.com/en-us/graph/use-the-api">Microsoft Graph API</a></b>
                        but had not really used it. The Graph API, a RESTful web API that enables access to Microsoft Cloud service resources, would become
                        to be my go-to solution, with its native support for M365 and helpful Azure commands, as well as several Microsoft PowerShell
                        modules specific for Exchange Online and Teams for example.
                        <br>
                        The challenge in automating this process lays in finding the right balance between automating the decision if
                        a specific toggle should be turned on or off based on security good practices, industry benchmarks, internal knowledge and
                        additionally taking the organization's context and challenges into account, as well as the general industry and threat landscape
                        to be able to account for exceptions. Solving this challenge will be indirectly discussed during the upcoming chapters, where the
                        automation of the assessment of an organization's security maturity is discussed.
                        <br><br>
                        <h3 id="post__content__title3">Adhering to Zero Trust and the principle of least privilege</h3>
                        Let's first discuss an arguably understandable worry of clients: running foreign scripts with permissions in their environments.
                        Clients, understandably, are in general hesitant when it comes to unknown scripts and privileges to third-parties, even when these
                        third-parties provide security services. By relying on the Microsoft Graph API, we were able to provide clients with a natively
                        supported interface within their M365 environment that allows for heavy restriction, usually raising exceptions and logon failures
                        if actions are performed without the right permissions or are downright blocked. Fortunately, it is quite easy and effortless to allow
                        the Graph API within an environment whilst simultaneously reducing the access that it obtains. Through creating an <b>
                            <a href="https://learn.microsoft.com/en-us/power-apps/developer/data-platform/walkthrough-register-app-azure-active-directory">application registration</a>
                        </b> within the Microsoft Entra Admin Center, one can specify the API permissions that should be granted to the Microsoft Graph API.
                        In this case Microsoft Graph API can be granted a limited subset of permissions to perform its task. Although a wide range of permissions is
                        required to perform the automated tenant assessment, it is limited to "read" rights, which limits the privileges that are obtained by the
                        application registration. Furthermore, the organization can then on a as-needed basis add users to the application registration. <b>
                            As a
                            result, only a single instance exists where  users obtain limited permissions to read configurations and when the application registration
                            is removed, no privileges are inherited by users.
                        </b>
                        <br>
                        <img class="rounded" src="/img/entra_appreg_apiperms.png" alt="Entra Tenant Assessment App Registrations" onclick="window.open(this.src, '_blank');"
                             width="561" , height="346" onmouseover="this.style.cursor='zoom-in'" onmouseout="this.style.cursor='default'">
                        <br><br>
                        <h3 id="post__content__title4">Developing the automated tenant assessment</h3>
                        The clients that I have come across usually run either Microsoft 365 Enterprise 3 (E3) or Microsoft 365 Enterprise 5 (E5) licenses. By taking
                        the distribution of products from M365Maps.com website as the ground truth, I have created 5 main assessment sections for E3 licenses: Entra ID P1
                        Intune P1, Defender for Endpoint P1, Office 365 E3, Windows Enterprise E3 and Defender for Office 365 P1, EMS E3 (separating Entra ID P1 and Intune
                        P1 from EMS E3). Note that Defender for Office 365 P1 is a stand-alone license that most clients have added on top of in their M365 E3 license.
                        For E5 licenses, I have created 8 assessment sections: Entra ID P2, Intune P1, Defender for Endpoint P2, Defender for Office 365 P2, Office 365 E5,
                        EMS E5, and the add-ons from M365 E5 Security and M365 E5 Compliance.
                        <br><br>
                        To be able to call the Graph API cmdlets, and use the cmdlets offered through the Teams and Exchange Online modules, we will need  to install these
                        three modules, before we can continue automating: <span id="inline-code">Install-Module Microsoft.Graph, Teams, ExchangeOnlineManagement -Scope CurrentUser</span>
                        <br><br>
                        In the end, I ended up creating a custom PowerShell module that users can import. This allows for a high flexibility and modulality of the assessment. Assessors
                        can either run the <span id="inline-code">Get-FullE3Report</span> or <span id="inline-code">Get-FullE5Report</span>
                        cmdlets which wil perform a full assessment over all the assessment sections, or call the individual assessment sections to get a dedicated report.
                        <br><br>
                        To account for non-technical assessors having to interpret, analyze and understand the results, I relied on HTML and CSS to help me out. By developing
                        a clean and simple dashboard, the results would be categorized by their assessment sections and each result would be displayed in a separate modal.
                        The modal includes not only the assessment results, but supports further functionality so that assessors could find out the point of the specific
                        test, the expected results and both a recommendation and supporting reasoning for the expected result. The aim of this, was to ensure that it could
                        be transfered into a report without someone having to look up the reasoning for or against enabling specific settings, and a default template was given.
                        Of course, each recommendation is generic, meaning that assessors would still need to analyze if the environment they performed the assessment in, would
                        by default benefit from the recommendation.
                        As you might imagine, I can't freely post the full assessment PowerShell module here, but I am happy to discuss details and ideas.
                        <br><br>
                        <h3 id="post__content__title4">A short demonstration</h3>
                        The chosen framework to build the automated tenant assessment in is PowerShell. It is natively supported by Windows and provides the most
                        versatile solution for the multiple APIs and Graph SDK that are used.<br>
                        An example of lowering the manual labor required for obtaining all security-related settings can be demonstrated through the Endpoint DLP
                        Settings in the Microsoft Purview Compliance Center. The Endpoint DLP Settings contain 14 main configurable settings of which multiple have
                        subsettings that allow for an even more finegrained configuration additionally. By manually going through every setting, a lot of clicking
                        and opening of subviews etc. is required. Additionally, one needs to properly document where these settings are located and doing that for
                        every single setting requires a lot of documentation. Furthermore, as Microsoft continuously improves and changes the layout of their products,
                        it is likely that locations of these settings may change, which requires that the documentation on where each setting is located needs to be
                        checked and updated in the documentation.
                        <br><br>
                        On the other hand, Microsoft provides through the Security & Compliance PowerShell a single cmdlet
                        <pre class="highlight-inline"><code>Get-PolicyConfig</code></pre>, to obtain the details on all 14 settings
                        and their respective subsettings, which can then be looped over and the results printed or stored as required.
                        A simple solution for implementing the cmdlet is demonstrated below:
                        <br><br>
                        <div class="container">
                            <div class="row">
                                <div class="col col-4" style="padding-left:8px;padding-right:8px;">
                                    <img src="/img/entra_tenant_assessment_dplsettings.png" alt="Entra Tenant Assessment Dashboard" onclick="window.open(this.src, '_blank');" onmouseover="this.style.cursor='zoom-in'" onmouseout="this.style.cursor='default'">
                                </div>
                                <div class="col col-8" style="padding-left:8px;padding-right:8px;">
                                    <div class="language-plaintext highlighter-rouge">
                                        <div class="highlight">
                                            <pre class="highlight"
                                                 style="padding-left: 10px; padding-right: 10px;"><code>$ClientId = "a0a0a0a0-0000-aaaa-0a0a-a0a0a0a0a0a0"<br>$TenantId = "f9f9f9f9-9999-ffff-9f9f-f9f9f9f9f9f9"<br><br>Connect-MgGraph -ClientId $ClientId -TenantId $TenantId<br><br>$dlpSettingsObject = Get-PolicyConfig<br>$dlpSettings = $dlpSettingsObject.EndpointDlpGlobalSettings<br>if ($dlpSettings) { <br>&emsp;foreach($dlpSetting in $dlpSettings) { <br>&emsp;&emsp;if ($null -ne $dlpSetting.Value and $null -ne $dlpSetting.Setting) { <br>&emsp;&emsp;&emsp;&emsp;Write-Host "$($dlpSetting.Setting): $($dlpSetting.Value)" <br>&emsp;&emsp;} <br>&emsp;} <br>}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </article>
        </div>
        <!-- end post -->
    </main>
    <!-- End of custom content -->

    <div class="top" title="Top"><i class="ion ion-ios-arrow-up"></i></div>
    <!-- begin footer-widgets -->
    <section class="footer-widgets">
        <div class="container">
            <div class="row">
                <div class="col col-4 col-d-6 col-t-12">
                    <div class="widget widget-tag-cloud">
                        <div class="widget__head">
                            <h3 class="widget__title">Explore Tags</h3>
                        </div>
                        <div class="tag__cloud">
                            <a href="/ctf/" class="set-1">CTF Writeups</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- end footer-widgets -->
    <!-- begin footer -->
    <footer class="footer">
        <div id="footer-content"></div>
    </footer>
    <!-- end footer -->
    <script src="/js/vendors/jquery-3.5.1.min.js"></script>
    <script src="/js/vendors/simple-jekyll-search.min.js"></script>
    <script src="/js/vendors/jquery.fitvids.js"></script>
    <script src="/js/vendors/lazyload.min.js"></script>
    <script src="/js/vendors/transition.js"></script>
    <script src="/js/vendors/zoom.min.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/readingtime.js"></script>
    <script>
        var base_url = "",
            pagination_next_url = base_url + '/page2',
            pagination_next_page_number = '',
            pagination_available_pages_number = '1';
    </script>
</body>

</html>